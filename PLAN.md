DOMベースのホワイトボードライブラリ開発について、tldrawを参考に具体的な計画を立てます。tldrawは優れたデザインとパフォーマンスを持つため、そのアプローチから多くのことを学び、あなたのプロジェクトに活かせるでしょう。

DOMベース ヘッドレス ホワイトボードライブラリ開発計画 (tldraw参考)
1. プロジェクトの概要と目標
プロジェクト名: DOMベース ヘッドレス ホワイトボードライブラリ

目標:

ヘッドレスなライブラリとして開発する。 (UI要素やスタイルを含まず、利用者が自由にUIを構築可能)

DOMベースで、描画（ペン、図形、テキスト）、選択、移動、拡大縮小の基本機能を提供。

将来的な機能拡張（共同編集、Undo/Redoなど）を見据えた拡張性と堅牢性を備えたアーキテクチャ設計を行う。

初期スコープ（段階的な定義）:
より小さく、段階的なスコープを定義し、確実に開発を進めます。

スコープ 0: プロトタイプ/コア機能 (MVP - Minimum Viable Product)

ビュー機能: 基本的なDOMベースのキャンバス表示（背景グリッドなど）、ズーム、パン（画面移動）

操作機能: シェイプの選択（クリック）、選択したシェイプの移動（ドラッグ）

ユーティリティ: 最小限の状態管理

スコープ 1: 基本的な描画と操作の完成

描画機能: 長方形の描画（シンプルな追加のみ）、楕円、直線の描画

操作機能: シェイプのリサイズ

ユーティリティ: Undo/Redoシステムの本格的な実装

スコープ 2: 高度な描画とユーティリティの追加

描画機能: フリーハンド、テキストの描画と編集

UI/操作: 描画ツールのプロパティ変更UI（色、線の太さなど）

ユーティリティ: コピー＆ペースト、複数シェイプの選択・移動・リサイズ、シェイプのZオーダー（描画順序）管理

データ管理: JSON形式でのデータ保存・読み込み、キーボードショートカット

2. 技術選定
DOMベースの特性を最大限に活かすため、以下の技術スタックを推奨します。

コア言語: TypeScript (型安全性、コードの品質向上)

ビルドツール: Vite (高速な開発サーバーとバンドル)

スタイリング: (本体には含めず、ユーザーが自由に適用)

本ライブラリは完全にヘッドレスであり、UIコンポーネントやスタイルは提供しません。描画要素のDOM構造とロジックに専念し、特定のCSSフレームワークやスタイルを強制しません。

サンプルアプリケーションでは、素のCSS（Pure CSS）を使用し、機能の実装に焦点を当てたシンプルなスタイリングを行います。

状態管理: Zustand または Jotai (tldrawが採用。軽量でパフォーマンスに優れる)

テスト: Vitest (Viteとの相性が良い)

リンター/フォーマッター: Biome

3. tldrawからの主要な学習点と実装への落とし込み
tldrawの設計思想と実装から、DOMベースのホワイトボードに適用できる重要な点を抽出します。

3.1. コアアーキテクチャとデータモデル
tldrawは、すべての描画要素を「シェイプ」という一貫したデータ構造で管理し、状態を不可変に扱うことでパフォーマンスを最適化しています。これを参考に、以下の点を実装します。

Shapeインターフェースの定義:

// TypeScriptでの例
interface BaseShape {
    id: string;
    type: 'rectangle' | 'ellipse' | 'line' | 'text' | 'freedraw';
    x: number; // ワールド座標
    y: number; // ワールド座標
    rotation: number; // ラジアン
    opacity: number;
    // その他の共通プロパティ (例: strokeColor, fill, strokeWidthなど)
}

interface RectangleShape extends BaseShape {
    type: 'rectangle';
    width: number;
    height: number;
}

interface TextShape extends BaseShape {
    type: 'text';
    text: string;
    fontSize: number;
}

// ...他のシェイプタイプ
type Shape = RectangleShape | TextShape | LineShape | EllipseShape | FreedrawShape;

中央集権的な状態ストア: shapes (全シェイプデータ), camera (ビューポート情報), selectedShapeIds (選択中のID), currentTool (現在のツール), history (Undo/Redo用スタック) を一元的に管理し、Zustandやカスタムクラスで状態変更時にUIが反応するように設計します。

3.2. 描画エンジンとDOM表現
tldrawはHTML DOM要素とCSS transformを積極的に活用し、高性能な描画を実現しています。これを参考に、以下の点を実装します。

DOM要素としての各Shapeの描画: キャンバス全体をラップする単一のdiv要素内に、各シェイプに対応するdiv、textarea、svg（またはcanvas）要素を絶対配置で描画します。

座標変換とCSS transformの活用: worldToScreenとscreenToWorld関数でワールド座標とスクリーン座標を変換します。pointermoveイベントなどで取得したスクリーン座標をワールド座標に変換し、シェイプデータを更新。更新されたシェイプデータに基づいてCSS transformプロパティ（translate, scale, rotate）を動的に適用し、リフロー/リペイントのコストを最小限に抑えつつ、DOM要素の位置と見た目を制御します。

3.3. ツールシステムとインタラクション
tldrawはステートマシンベースのツールシステムとイベント抽象化により、インタラクティブな操作を実現しています。これを参考に、以下の点を実装します。

Toolインターフェース/抽象クラス: ツールの共通APIを定義します。

// TypeScriptでの例
interface Tool {
    id: string;
    activate(): void; // ツールがアクティブになったときに呼ばれる
    deactivate(): void; // ツールが非アクティブになったときに呼ばれる
    onPointerDown(e: PointerEvent): void; // ポインターダウンイベントハンドラ
    onPointerMove(e: PointerEvent): void; // ポインタームーブイベントハンドラ
    onPointerUp(e: PointerEvent): void; // ポインターアップイベントハンドラ
    // ...その他のイベントハンドラ (onKeyDown, onDoubleClickなど)
}

具体的なツールクラスの実装: SelectTool、RectangleTool、PenTool、TextToolなどを実装し、それぞれのイベントハンドラで描画・編集ロジックを記述します。

Undo/Redoシステム: コマンドパターンを採用し、各操作をexecute()とundo()メソッドを持つコマンドオブジェクトとして定義。これらを履歴スタックにプッシュすることでUndo/Redo機能を実現します。

3.4. ズーム・パン機能
tldrawはcameraオブジェクトでビューポートを一元管理し、スムーズなズーム・パンを提供します。これを参考に、以下の点を実装します。

camera状態 ({ x: number, y: number, zoom: number }) を状態ストアに保持します。

キャンバスの親要素にtransform: translate(-camera.x * camera.zoom, -camera.y * camera.zoom) scale(camera.zoom)を適用することで、子要素である各シェイプの表示を制御します。

マウスホイールイベントでcamera.zoomを更新し、ドラッグイベント（pointerdown, pointermove, pointerup）でcamera.x, camera.yを更新します。

4. 開発フェーズとマイルストーン
上記の段階的なスコープ定義に合わせて、開発フェーズを再構築します。

フェーズ 0: プロトタイプ/コア機能 (MVP) の構築
プロジェクトセットアップ (TypeScript, Vite)

基本的なDOMベースのキャンバス表示（背景グリッド）

Shapeインターフェースの定義とシンプルなデータモデル設計

中央集権的な状態ストアの基本構築

ビューポートとカメラの状態管理、座標変換ヘルパー関数の実装

ズーム・パン機能（マウスホイール、ドラッグ）の実装

シェイプの選択機能（クリックで選択状態をトグル）

選択したシェイプの移動機能（ドラッグでの位置変更）

基本的なコード整理とテスト環境の準備

主要なイベントハンドラの抽象化の基盤構築

マイルストーン 0: ズーム・パン、シェイプの選択、移動が可能なMVPが完成。基本的なDOM操作と状態管理の骨格が確立される。

フェーズ 1: 基本的な描画と操作の完成
描画機能: 長方形の描画（シンプルな追加のみ）、楕円、直線の描画

シェイプのリサイズ機能（選択ボックスのハンドルによるサイズ変更）

Undo/Redoシステムの本格的な実装（コマンドパターンに基づく）

リファクタリングとパフォーマンス改善（特に描画部分）

マイルストーン 1: 長方形、楕円、直線、選択、移動、リサイズ、Undo/Redoが問題なく動作する基本的なホワイトボード機能が完成。

フェーズ 2: 高度な描画とユーティリティの追加
フリーハンドツール（SVG path要素または<canvas>要素を利用した滑らかな描画）

テキストツール（textarea要素での編集、Enterキーで確定、自動リサイズなど）

描画ツールのプロパティ変更UIの実装

コピー＆ペースト機能の実装

複数シェイプの選択、移動、リサイズ機能の拡張

シェイプのZオーダー（描画順序）管理機能

JSON形式でのデータ保存・読み込み機能

主要な操作に対するキーボードショートカットの追加

総合的なテストと品質向上、ドキュメンテーション

マイルストーン 2: ライブラリとしての主要な機能が全て完成し、安定した動作と豊富なユーティリティが利用可能になる。

5. 考慮事項と課題
パフォーマンス最適化: DOM操作はCanvasに比べて重くなりがちなため、CSS transformの活用、必要なDOM要素のみの更新、描画範囲外の要素の非表示化（仮想化）などを常に意識します。

イベント処理の複雑さ: pointerdown、pointermove、pointerupなどのイベントハンドリングは、ツールの状態に応じて複雑になりがちです。ステートマシンを明確に定義し、クリーンなコードを保つことが重要です。

テキスト編集: テキストボックスの自動リサイズ、フォントの読み込み、キャレット（カーソル）の位置管理など、DOMベースのテキスト編集は奥深いです。

将来的な拡張: 共同編集やより複雑な図形、画像埋め込みなどを考慮し、データモデルとAPIは可能な限り柔軟に設計します。

スタイリングの分離: ライブラリ本体は機能とDOM構造に徹し、スタイリングは利用者側のCSSに委ねます。これにより、ライブラリの柔軟性と再利用性が向上します。

tldrawのシステム構造概要図
tldrawのアーキテクチャを参考に、本ライブラリの主要コンポーネントとその相互作用を示す概要図を以下に示します。

graph TD
    A[ユーザー操作/DOMイベント] --> B(イベント抽象化層);
    B --> C{ツールシステム};
    C --> D[中央集権的な状態ストア];
    D --> E[データモデル/シェイプ];

    D -- 状態変更 --> F(描画エンジン);
    F --> G[DOM表現/CSS Transform];
    G --> H[ユーザーインターフェース (利用者側で実装)];

    subgraph ツールシステム
        C -- SelectTool --> D;
        C -- RectangleTool --> D;
        C -- PenTool --> D;
        C -- TextTool --> D;
    end

    subgraph 状態管理とデータ
        D -- ズーム/パン --> Camera;
        D -- 履歴管理 --> History[Undo/Redoスタック];
    end

    subgraph 描画と表示
        F -- 座標変換 --> CanvasCoordinateSystem[キャンバス座標系];
        G -- 高速描画 --> GPUAcceleration;
    end

    H -- ツール選択など --> C;
    H -- 操作変更 --> D;

図の解説:

ユーザー操作/DOMイベント (A): マウスのクリック、ドラッグ、ホイール、キーボード入力など、ユーザーが行うすべての操作。

イベント抽象化層 (B): 低レベルなDOMイベントを高レベルなポインターイベントに抽象化。

ツールシステム (C): 各ツール（選択、長方形、ペンなど）のロジックを管理するステートマシン。イベントを受け取り、状態ストアに指示を出します。

中央集権的な状態ストア (D): ホワイトボード全体の状態（シェイプ、カメラ、選択、ツールなど）を一元管理。

データモデル/シェイプ (E): すべての描画要素のデータ構造を定義。

描画エンジン (F): 状態ストアのデータ変更を検知し、DOMを更新するロジック。

DOM表現/CSS Transform (G): 実際のDOM要素としてシェイプを描画し、CSS transformで高性能な描画を実現。

ユーザーインターフェース (利用者側で実装) (H): 本ライブラリはヘッドレスであるため、UI要素は利用者が独自に構築。

tldrawのパッケージ間の関係
tldrawのモノレポ構造は、ヘッドレスライブラリとして開発する際のモジュール分割の参考になります。

graph TD
    A[packages/tlschema] -- データ型定義 --> B[packages/core];
    A -- データ型定義 --> C[packages/editor];
    B -- コアロジック提供 --> C;
    C -- 編集ロジック/状態更新 --> D[packages/tldraw];
    D -- UI/アプリケーション --> E[ユーザーアプリケーション];

    subgraph 共通
        B -- ユーティリティ --> F[packages/utils];
        C -- ユーティリティ --> F;
        D -- ユーティリティ --> F;
    end

    subgraph tldrawアプリ
        D -- UIコンポーネント --> G[packages/ui];
    end

    style D fill:#f9f,stroke:#333,stroke-width:2px;
    linkStyle 0 stroke:#00a,stroke-width:2px,fill:none;
    linkStyle 1 stroke:#00a,stroke-width:2px,fill:none;
    linkStyle 2 stroke:#0a0,stroke-width:2px,fill:none;
    linkStyle 3 stroke:#a00,stroke-width:2px,fill:none;
    linkStyle 4 stroke:#00f,stroke-width:2px,fill:none;
    linkStyle 5 stroke:#00f,stroke-width:2px,fill:none;
    linkStyle 6 stroke:#00f,stroke-width:2px,fill:none;

図の解説:

packages/tlschema (A): 全てのデータスキーマと型定義。本ライブラリの基盤。

packages/core (B): ホワイトボードの基本的なロジック、状態管理、座標変換。ヘッドレスライブラリの核。

packages/editor (C): ツール動作、Undo/Redo、キーボードショートカットなどエディタのインタラクティブなロジック。ヘッドレスライブラリの主要API層。

packages/tldraw (D): tldrawアプリケーション本体。editorを利用し、UIを構築する層（本ライブラリの利用例）。

packages/utils (F): 共通のヘルパー関数。

packages/ui (G): tldrawアプリ固有のUIコンポーネント。本ヘッドレスライブラリには含まれません。

ユーザーアプリケーション (E): 本ライブラリ（editor/core）を利用し、独自のUIを構築する最終アプリケーション。

このパッケージ構造は、機能の関心事を明確に分離し、依存関係を一方通行に保つことで、高い凝集度と低い結合度を実現し、ライブラリの保守性と拡張性を高めています。

この計画は、tldrawの優れたアプローチをDOMベースの環境に適用するための指針となるでしょう。本ライブラリは、UIを持たない「ヘッドレス」な形で提供され、利用者がその上に独自のユーザーインターフェースを構築できることを目指します。 段階的に開発を進め、各フェーズで機能を検証しながら、質の高いホワイトボードライブラリを構築してください。
